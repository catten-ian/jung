<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>è£æ ¼è¯æ±‡è”æƒ³æµ‹è¯•ï½œè¯­éŸ³ç‰ˆï¼ˆæ•´åœºå½•éŸ³ / æ¯é¢˜å½•éŸ³ / ä¸å½•éŸ³ï¼‰</title>
  <style>
    :root{--bg:#0b0f14;--card:#121822;--muted:#8fa3b0;--text:#e6edf3;--acc:#4cc9f0;--good:#2ecc71;--warn:#f39c12;--bad:#e74c3c}
    html,body{height:100%;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji}
    .wrap{max-width:980px;margin:0 auto;padding:24px}
    h1{font-size:clamp(20px,3.4vw,32px);margin:0 0 8px}
    p{color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:16px}
    @media (min-width:900px){.grid{grid-template-columns:360px 1fr}}
    .card{background:var(--card);border:1px solid #223044;border-radius:16px;box-shadow:0 8px 30px rgba(0,0,0,.25)}
    .card h2{margin:0;padding:16px 16px 0;font-size:18px;color:#cdd9e5}
    .card .body{padding:16px}
    label{display:block;margin:10px 0 6px;color:#cbd5e1}
    input[type=text],input[type=number],select,textarea{width:100%;background:#0b1119;border:1px solid #2b3a4a;border-radius:10px;color:var(--text);padding:10px 12px;outline:none}
    textarea{min-height:92px}
    button{appearance:none;border:0;border-radius:12px;padding:12px 16px;background:var(--acc);color:#002033;font-weight:700;cursor:pointer}
    button.secondary{background:#203040;color:#cfe9f6;border:1px solid #305068}
    button.ghost{background:transparent;border:1px dashed #3b5368;color:#bfdded}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    .center{display:flex;align-items:center;justify-content:center;text-align:center}
    .stimulus{font-size:clamp(34px,6vw,64px);letter-spacing:.5px;margin:6px 0 8px}
    .muted{color:var(--muted)}
    .pill{display:inline-block;padding:4px 10px;border:1px solid #2b3a4a;border-radius:999px;color:#b6c7d4;font-size:12px}
    .progress{height:10px;width:100%;background:#101820;border-radius:999px;overflow:hidden;border:1px solid #213144}
    .progress > div{height:100%;width:0;background:linear-gradient(90deg,var(--acc),#a1ffd5);transition:width .2s}
    .kbd{font-family:ui-monospace,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;background:#0d1520;border:1px solid #2a3a4a;border-radius:6px;padding:2px 6px}
    .log{max-height:300px;overflow:auto;background:#0b1119;border:1px solid #213144;border-radius:12px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:8px 10px;border-bottom:1px solid #1e2a38;vertical-align:top}
    tr:hover td{background:#0d1520}
    .badge{font-size:12px;margin-left:6px}
    .rec-ind{display:inline-flex;align-items:center;gap:8px}
    .dot{width:10px;height:10px;border-radius:50%;background:#666}
    .dot.live{background:#ff3b3b;box-shadow:0 0 0 6px rgba(255,59,59,.15)}
    audio{width:240px}
    .footer{opacity:.7;font-size:12px;margin-top:12px}
    .err{color:#ff9aa2}
    details.dev summary{cursor:pointer}
    .devlog{white-space:pre-wrap;background:#0b1119;border:1px solid #213144;border-radius:12px;padding:10px;font-family:ui-monospace,Menlo,Consolas}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>è£æ ¼è¯æ±‡è”æƒ³æµ‹è¯•ï¼ˆè¯­éŸ³ç‰ˆï¼‰ <span class="pill">æ•´åœºï¼æ¯é¢˜ï¼ä¸å½•éŸ³</span></h1>
    <p class="muted">å¦‚æœ<strong>ä¸ä½¿ç”¨ ASR</strong>ï¼Œå¯é€‰æ‹©â€œæ•´åœºå•æ®µå½•éŸ³â€ï¼šä»å¼€å§‹åˆ°ç»“æŸåªå½• <strong>ä¸€æ®µ</strong> éŸ³é¢‘ã€‚ä¹Ÿå¯é€‰â€œæ¯é¢˜å½•éŸ³â€æˆ–â€œ<strong>ä¸å½•éŸ³</strong>â€ï¼ˆæ­¤æ—¶æŒ‰é’®æ–‡æ¡ˆä¼šå˜ä¸ºâ€œå¼€å§‹ååº”/ä¸‹ä¸€ä¸ªâ€ï¼‰ã€‚</p>

    <div id="secureWarn" class="card" style="display:none">
      <div class="body">
        <p class="err"><strong>å½“å‰é¡µé¢éå®‰å…¨ä¸Šä¸‹æ–‡ï¼ˆå¦‚ content:// æˆ– file://ï¼‰ã€‚æµè§ˆå™¨å°†æ‹’ç»éº¦å…‹é£æƒé™ã€‚</strong></p>
        <ul>
          <li>è¯·ç”¨ <strong>Chrome</strong> æ‰“å¼€æ­¤é¡µé¢ï¼Œå¹¶é€šè¿‡ <strong>https://</strong> æˆ– <strong>http://localhost</strong> è®¿é—®ã€‚</li>
          <li>é¿å…åœ¨åº”ç”¨å†…ç½®æµè§ˆå™¨/æ–‡ä»¶é¢„è§ˆä¸­æ‰“å¼€ï¼ˆå¦‚å¾®ä¿¡ã€æ–‡ä»¶ç®¡ç†å™¨ï¼‰ã€‚</li>
        </ul>
      </div>
    </div>

    <div class="grid">
      <!-- å·¦ä¾§ï¼šè®¾ç½® -->
      <section class="card" aria-labelledby="cfgTitle">
        <h2 id="cfgTitle">æµ‹è¯•è®¾ç½®</h2>
        <div class="body">
          <div class="row">
            <div>
              <label>ç ”ç©¶/é¡¹ç›®ç¼–å·</label>
              <input id="studyId" type="text" placeholder="å¦‚: JWAT-2025-A" />
            </div>
            <div>
              <label>è¢«è¯•ç¼–å·</label>
              <input id="pid" type="text" placeholder="å¦‚: S001" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>å¹´é¾„</label>
              <input id="age" type="number" min="1" max="120" />
            </div>
            <div>
              <label>æ€§åˆ«</label>
              <select id="sex">
                <option value="">æœªå¡«å†™</option>
                <option value="F">å¥³</option>
                <option value="M">ç”·</option>
                <option value="O">å…¶ä»–/ä¸æ„¿é€éœ²</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div>
              <label>é—´éš”ï¼ˆISI, msï¼‰</label>
              <input id="isi" type="number" min="0" value="800" />
            </div>
            <div>
              <label>å•é¢˜å½•éŸ³ä¸Šé™ï¼ˆmsï¼‰<span class="badge muted">ä»…â€œæ¯é¢˜å½•éŸ³â€æœ‰æ•ˆï¼›0=ä¸é™åˆ¶</span></label>
              <input id="maxDur" type="number" min="0" value="8000" />
            </div>
          </div>

          <div class="row">
            <div>
              <label>é¡ºåº</label>
              <select id="order">
                <option value="original">æŒ‰è¯è¡¨é¡ºåº</option>
                <option value="random">éšæœº</option>
              </select>
            </div>
            <div>
              <label>å½•éŸ³æ¨¡å¼</label>
              <select id="recMode">
                <option value="session_single">æ•´åœºå•æ®µ</option>
                <option value="trial_manual">æ¯é¢˜æ‰‹åŠ¨</option>
                <option value="trial_auto">æ¯é¢˜è‡ªåŠ¨</option>
                <option value="none">ä¸å½•éŸ³</option>
              </select>
            </div>
          </div>

          <label>è‡ªå®šä¹‰è¯è¡¨ï¼ˆæ¯è¡Œä¸€ä¸ªï¼›ç©ºè¡Œå°†è¢«å¿½ç•¥ï¼‰</label>
          <textarea id="customList" placeholder="å¯ç²˜è´´ä½ çš„è¯è¡¨â€¦"></textarea>

          <div class="row" style="margin-top:10px">
            <button id="btnStart">å¼€å§‹æµ‹è¯•ï¼ˆæˆ–æŒ‰ <span class="kbd">S</span>ï¼‰</button>
            <button id="btnStop" class="secondary" disabled>ç»“æŸ/ä¿å­˜</button>
            <button id="btnReset" class="ghost">æ¸…ç©ºç»“æœ</button>
          </div>

          <hr style="border-color:#1e2a38;border-style:solid;border-width:1px 0 0;margin:16px 0">
          <h3 style="margin:0 0 8px;font-size:16px;color:#cdd9e5">é™éŸ³åˆ†å‰²ï¼ˆä»…â€œæ¯é¢˜å½•éŸ³Â·é€‰é¡¹Câ€ï¼‰</h3>
          <div class="row">
            <div>
              <label>å¯ç”¨é™éŸ³åˆ†å‰²</label>
              <select id="segEnable">
                <option value="on">å¼€å¯</option>
                <option value="off">å…³é—­</option>
              </select>
            </div>
            <div>
              <label>é™éŸ³é˜ˆå€¼ï¼ˆRMSï¼Œ0-1ï¼‰</label>
              <input id="segThresh" type="number" min="0" max="1" step="0.001" value="0.015" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>æœ€çŸ­é™éŸ³ï¼ˆmsï¼‰</label>
              <input id="segMinSil" type="number" min="50" step="50" value="350" />
            </div>
            <div>
              <label>æœ€çŸ­ç‰‡æ®µï¼ˆmsï¼‰</label>
              <input id="segMinChunk" type="number" min="100" step="50" value="200" />
            </div>
          </div>

          <div class="row" style="margin-top:12px">
            <div>
              <label>å¯ç”¨è¯­éŸ³è¯†åˆ«ï¼ˆå¯é€‰ï¼‰</label>
              <select id="asrEnable">
                <option value="off">å…³é—­</option>
                <option value="on">å¼€å¯ï¼ˆéœ€è¦ä½ å¡« APIï¼‰</option>
              </select>
            </div>
            <div>
              <label>ASR API åœ°å€ï¼ˆPOST ä¸Šä¼ éŸ³é¢‘ï¼‰</label>
              <input id="asrUrl" type="text" placeholder="https://your-asr.example/v1/transcribe" />
            </div>
          </div>
          <div class="row">
            <div>
              <label>ASR API Key</label>
              <input id="asrKey" type="text" placeholder="ç•™ç©ºå¾…ä½ å¡«å†™" />
            </div>
            <div>
              <label>ASR é¢å¤–å‚æ•°ï¼ˆJSONï¼Œå¯ç©ºï¼‰</label>
              <input id="asrExtra" type="text" placeholder='{"lang":"zh"}' />
            </div>
          </div>

          <p class="footer">å»ºè®®é€šè¿‡ <strong>HTTPS æˆ– localhost</strong> æ‰“å¼€æœ¬é¡µã€‚å¿«æ·é”®ï¼š<span class="kbd">S</span> å¼€å§‹ï¼Œ<span class="kbd">R</span> å¼€/åœï¼ˆæ¯é¢˜æˆ–æ•´åœºï¼‰ï¼Œ<span class="kbd">Space</span> è·³è¿‡/ä¸‹ä¸€ä¸ªï¼Œ<span class="kbd">Esc</span> æš‚åœã€‚</p>
        </div>
      </section>

      <!-- å³ä¾§ï¼šå®éªŒåŒº -->
      <section class="card" aria-labelledby="runTitle">
        <h2 id="runTitle">å®éªŒè¿›è¡ŒåŒº</h2>
        <div class="body">
          <div class="progress" aria-label="è¿›åº¦"><div id="progBar" style="width:0%"></div></div>

          <div id="stage" class="center" style="min-height:170px;flex-direction:column;margin-top:12px">
            <div class="pill" id="status">æœªå¼€å§‹</div>
            <div class="stimulus" id="stimulus">â€”</div>
            <div class="muted" id="timers">é¦–ååº”å»¶è¿Ÿï¼šâ€” ms Â· ååº”/å½•éŸ³æ—¶é•¿ï¼šâ€” ms</div>
            <div class="rec-ind"><span>å½•éŸ³çŠ¶æ€ï¼š</span><span id="recDot" class="dot"></span><span id="recLabel" class="muted">ç©ºé—²</span></div>
            <p id="permHint" class="err" style="display:none;margin-top:8px">æ— æ³•è®¿é—®éº¦å…‹é£ï¼šè¯·ç¡®è®¤å·²æˆäºˆæµè§ˆå™¨éº¦å…‹é£æƒé™ï¼Œå¹¶ç¡®ä¿é€šè¿‡ HTTPS æˆ– localhost æ‰“å¼€ã€‚</p>
          </div>

          <div class="row" style="margin-top:8px">
            <button id="btnRec">å¼€å§‹å½•éŸ³ï¼ˆRï¼‰</button>
            <button id="btnStopRec" class="secondary" disabled>åœæ­¢å½•éŸ³</button>
            <button id="btnSkip" class="secondary" disabled>è·³è¿‡/æ— ååº”ï¼ˆSpaceï¼‰</button>
            <button id="btnPause" class="ghost" disabled>æš‚åœï¼ˆEscï¼‰</button>
          </div>

          <div id="sessionAudioBox" class="muted" style="display:none;margin-top:8px"></div>

          <label for="note">å¤‡æ³¨ï¼ˆå¯é€‰ï¼Œæƒ…ç»ªã€çŠ¹è±«ã€å¤–ç•Œå¹²æ‰°ç­‰ï¼‰</label>
          <input id="note" type="text" autocomplete="off" placeholder="å¯é€‰" disabled />

          <div class="log" style="margin-top:14px">
            <table id="tbl"><thead>
              <tr><th>#</th><th>åˆºæ¿€è¯</th><th>é¦–ååº”(ms)</th><th>ååº”/å½•éŸ³æ—¶é•¿(ms)</th><th>ASRæ–‡æœ¬</th><th>éŸ³é¢‘</th><th>å¤‡æ³¨</th></tr>
            </thead><tbody></tbody></table>
          </div>

          <div class="row" style="margin-top:10px">
            <button id="btnExportCsv" class="secondary" disabled>å¯¼å‡º CSV</button>
            <button id="btnExportJson" class="secondary" disabled>å¯¼å‡º JSON</button>
          </div>
        </div>
      </section>
    </div>

    <details class="card dev" style="margin-top:16px">
      <summary class="body"><strong>å¼€å‘è€…è‡ªæ£€ï¼ˆç‚¹å‡»å±•å¼€/æ”¶èµ·ï¼‰</strong></summary>
      <div class="body">
        <div class="row">
          <button id="btnRunTests" class="secondary">è¿è¡Œå†…ç½®è‡ªæ£€</button>
        </div>
        <p class="muted">æµ‹è¯•ç”¨ä¾‹è¦†ç›–ï¼šæ¢è¡Œåˆ‡åˆ†ã€CSV è½¬ä¹‰ã€CSV ç»“æ„ã€é™éŸ³åˆ†å‰²é˜ˆå€¼é€»è¾‘ã€æ­£åˆ™å¯ç¼–è¯‘ã€æ¨¡å¼æŒ‰é’®æ–‡æ¡ˆã€‚</p>
        <pre id="devLog" class="devlog"></pre>
      </div>
    </details>
  </div>

  <script>
  const $ = s=>document.querySelector(s);
  const now = ()=>performance.now();
  const sleep = ms=>new Promise(r=>setTimeout(r,ms));

  function download(filename, data, type='text/plain;charset=utf-8'){
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([data],{type})); a.download=filename; a.click(); URL.revokeObjectURL(a.href);
  }
  function csvEscape(v){ if(v==null) return ''; const s=String(v).replaceAll('"','""'); return /[",\n]/.test(s)?'"'+s+'"':s; }

  const JUNG_100=["å¤´","ç»¿è‰²","æ°´","å”±æ­Œ","åé¢","æ­¥ä¼","å®¢äºº","ç™½è‰²","é•¿","èˆ¹","æ…·æ…¨","ç¥ç¦","çŠ¹è±«","æŠ±æ€¨","ç‚½çƒ­","é—¨","è‡ªè±ª","æ‰«å¸š","é©±ä½¿","æµ·","é¥¥é¥¿","é—®å€™","æ³¥åœŸ","ç¡çœ ","ä¹¦","è´ªå©ª","æ—…è¡Œ","å¥½","å¯’å†·","ç˜Ÿç–«","ç¯®å­","å‹è°Š","èˆŒå¤´","ç•™æ„","åºŠ","åºŠå•","åˆ€","é¹°","è¨€è¯­","åœ†","é›ª","å°–é”","æ¡Œå­","çƒ‚","å›½ç‹","åå’½","æ ¹","çŠ","è“è‰²","ç¾Š","ç‰›å¥¶","ä¼¤å£","å¸­å­","æ ‘æ","ç›","ç‹ç‹¸","å¹²ç‡¥","èœ‚èœœ","æ•™å ‚","å°è·¯","éª„å‚²","ç¾è€»","æ£®æ—","å±‹é¡¶","é©¬","é“","æ¯å­","åº„ç¨¼","ç‡•å­","æ•Œäºº","è·¯","å‹‡æ•¢","ä¼ªå–„","å†œå¤«","æ ‘","å…¬æ­£","ç©·","ç»Ÿæ²»","äº²æˆš","ç‰›","é¢åŒ…","ç›æ°´","é­å­","çª—æˆ·","ç«","æ‰‹å¥—","ç»³å­","å±‹å­","å†œåœº","è‰","æ¤…å­","è€å¸ˆ","ç¬”","ç¾Šæ¯›","é¸¡","åŸé•‡","é‡‘å­","é»‘è‰²","èŠ±","é±¼"];

  let state={running:false,paused:false,order:'original',isi:800,maxDur:8000,autoRec:'off',list:[],idx:0,tStim:0,tRecStart:0,meta:{},results:[],media:null,rec:null,recTimeout:null,chunks:[],
             recMode:'session_single', sessionRec:null, sessionChunks:[], sessionStart:0};

  // ===== å®‰å…¨ä¸Šä¸‹æ–‡é¢„æ£€ =====
  (function secureCheck(){
    const isSecure = window.isSecureContext || /^https:/i.test(location.protocol) || /^(http:\/\/localhost|http:\/\/127\.0\.0\.1)/i.test(location.href);
    if(!isSecure){ $('#secureWarn').style.display='block'; }
  })();

  function loadParams(){
    state.order=$('#order').value; state.isi=+($('#isi').value||0); state.maxDur=+($('#maxDur').value||0); state.recMode=$('#recMode').value;
    const custom=$('#customList').value.trim().split(/\r?\n|\r/).map(s=>s.trim()).filter(Boolean); // å¿½ç•¥ç©ºè¡Œ
    state.list=custom.length?custom:[...JUNG_100];
    if(state.order==='random'){ for(let i=state.list.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [state.list[i],state.list[j]]=[state.list[j],state.list[i]]; } }
    state.idx=0; state.results=[];
    state.meta={studyId:$('#studyId').value.trim(),pid:$('#pid').value.trim(),age:$('#age').value||'',sex:$('#sex').value||'',startedAt:new Date().toISOString(),isi:state.isi,maxDur:state.maxDur,order:state.order,listSize:state.list.length,userAgent:navigator.userAgent,recMode:state.recMode,asrEnable:$('#asrEnable').value,segEnable:$('#segEnable').value,segThresh:+$('#segThresh').value,segMinSil:+$('#segMinSil').value,segMinChunk:+$('#segMinChunk').value};
    refreshModeUI();
  }

  function refreshModeUI(){
    const m=state.recMode;
    const usePerTrial = (m==='trial_manual'||m==='trial_auto');
    $('#segEnable').disabled=!usePerTrial; $('#segThresh').disabled=!usePerTrial; $('#segMinSil').disabled=!usePerTrial; $('#segMinChunk').disabled=!usePerTrial;
    if(m==='none' || m==='session_single'){
      $('#btnRec').textContent='å¼€å§‹ååº”ï¼ˆRï¼‰';
      $('#btnStopRec').textContent='ä¸‹ä¸€ä¸ª';
    }else{
      $('#btnRec').textContent='å¼€å§‹å½•éŸ³ï¼ˆRï¼‰';
      $('#btnStopRec').textContent='åœæ­¢å½•éŸ³';
    }
  }

  function setUIRunning(on){ $('#btnStart').disabled=on; $('#btnStop').disabled=!on; $('#btnReset').disabled=on; $('#btnSkip').disabled=!on; $('#btnPause').disabled=!on; $('#note').disabled=!on; $('#btnRec').disabled=!on; $('#btnStopRec').disabled=!on; }
  function updateProgress(){ const pct=state.list.length?Math.min(100,Math.round((state.idx/state.list.length)*100)):0; $('#progBar').style.width=pct+'%'; }
  function setStatus(t){ $('#status').textContent=t; }
  function setStim(t){ $('#stimulus').textContent=t; }
  function setTimers(first,len){ $('#timers').textContent=`é¦–ååº”å»¶è¿Ÿï¼š${first??'â€”'} ms Â· ååº”/å½•éŸ³æ—¶é•¿ï¼š${len??'â€”'} ms`; }
  function recUI(live){ $('#recDot').classList.toggle('live',!!live); $('#recLabel').textContent= live? 'å½•éŸ³ä¸­â€¦':'ç©ºé—²'; }

  async function start(){
    if(state.running) return; loadParams(); if(!state.meta.pid){ alert('è¯·å¡«å†™â€œè¢«è¯•ç¼–å·â€ã€‚'); return; }
    $('#permHint').style.display='none';
    try{
      state.media= await navigator.mediaDevices.getUserMedia({audio:true});
    }catch(err){ $('#permHint').style.display='block'; alert('æ— æ³•è®¿é—®éº¦å…‹é£ï¼š'+(err && err.name? err.name+': '+err.message : err)); return; }

    // æ•´åœºå•æ®µï¼šä¸€å¼€å§‹å°±å¼€å½•
    if(state.recMode==='session_single'){
      startSessionRecording();
    }

    state.running=true; state.paused=false; setUIRunning(true); setStatus('è¿›è¡Œä¸­'); setTimers('â€”','â€”'); updateProgress();
    await presentNext(true);
  }

  function startSessionRecording(){
    try{
      state.sessionChunks=[]; state.sessionRec = new MediaRecorder(state.media,{mimeType: MediaRecorder.isTypeSupported('audio/webm;codecs=opus')? 'audio/webm;codecs=opus':'audio/webm'});
      state.sessionRec.ondataavailable=e=>{ if(e.data && e.data.size>0) state.sessionChunks.push(e.data); };
      state.sessionRec.start(); state.sessionStart = now();
      const box=$('#sessionAudioBox'); box.style.display='block'; box.textContent='æ•´åœºå½•éŸ³ä¸­â€¦ï¼ˆç»“æŸ/ä¿å­˜åå¯ä¸‹è½½æ•´æ®µéŸ³é¢‘ï¼‰';
    }catch(e){ alert('æ­¤ç¯å¢ƒä¸æ”¯æŒæ•´åœºå½•éŸ³ï¼š'+e); }
  }

  function stopSessionRecording(){
    return new Promise(res=>{
      if(state.sessionRec && state.sessionRec.state==='recording'){
        state.sessionRec.onstop=()=>res();
        state.sessionRec.stop();
      }else{ res(); }
    });
  }

  async function presentNext(initial=false){
    if(!initial){ setStim('â‹¯'); setTimers('â€”','â€”'); await sleep(state.isi); }
    if(state.idx>=state.list.length){ finish(); return; }
    const w=state.list[state.idx]; setStim(w); state.tStim=now(); state.tRecStart=0; updateProgress(); $('#note').value='';
    if(state.recMode==='trial_auto'){ startRec(); }
  }

  function startRec(){
    if(!state.running || state.recMode==='none') { // ä¸å½•éŸ³æ¨¡å¼ï¼šåªæ‰“ç‚¹
      if(!state.running) return; if(state.tRecStart) return; state.tRecStart= now(); setTimers(Math.round(state.tRecStart-state.tStim),'â€”'); return; }
    if(state.recMode==='session_single'){ // æ•´åœºå•æ®µï¼šæ¯é¢˜åªæ‰“ç‚¹
      if(state.tRecStart) return; state.tRecStart= now(); setTimers(Math.round(state.tRecStart-state.tStim),'â€”'); return;
    }
    if(state.rec) return;
    state.tRecStart= now(); setTimers(Math.round(state.tRecStart-state.tStim),'â€”');
    state.chunks=[]; try{
      state.rec = new MediaRecorder(state.media,{mimeType: MediaRecorder.isTypeSupported('audio/webm;codecs=opus')? 'audio/webm;codecs=opus':'audio/webm'});
    }catch(e){ alert('æ­¤ç¯å¢ƒä¸æ”¯æŒ MediaRecorderï¼š'+e); return; }
    recUI(true); $('#btnRec').disabled=true; $('#btnStopRec').disabled=false;
    state.rec.ondataavailable=e=>{ if(e.data && e.data.size>0) state.chunks.push(e.data); };
    state.rec.onstop= async ()=>{ recUI(false); $('#btnRec').disabled=false; $('#btnStopRec').disabled=true; clearTimeout(state.recTimeout);
      const blob=new Blob(state.chunks,{type: state.chunks[0]?.type || 'audio/webm'});
      const dur=Math.round(now()-state.tRecStart);
      await saveTrial(blob,dur);
      state.idx++; presentNext();
    };
    state.rec.start(); if(state.maxDur>0){ state.recTimeout=setTimeout(()=>{ if(state.rec && state.rec.state==='recording') stopRec(); }, state.maxDur); }
  }

  function stopRec(){
    if(state.recMode==='none' || state.recMode==='session_single'){
      // ä½œä¸ºâ€œä¸‹ä¸€ä¸ªâ€ä½¿ç”¨ï¼šè®°å½•ååº”æ—¶é—´å¹¶å…¥è¡¨ï¼ˆæ— éŸ³é¢‘ï¼‰
      const dur = state.tRecStart? Math.round(now()-state.tRecStart): 0;
      saveTrial(null,dur).then(()=>{ state.idx++; presentNext(); });
      return;
    }
    if(state.rec && state.rec.state==='recording'){ state.rec.stop(); state.rec=null; }
  }

  function skipCurrent(){ if(!state.running) return; if(state.rec && state.rec.state==='recording'){ stopRec(); return; }
    const w=state.list[state.idx]; const row={index:state.results.length+1, word:w, firstLatency: state.tRecStart?Math.round(state.tRecStart-state.tStim):'', duration:0, note:($('#note').value||'').trim(), asrText:'', audioUrl:'', audioName:'', mime:''};
    addRow(row); state.results.push({...row});
    localStorage.setItem('JWAT_VOICE_LAST', JSON.stringify({meta:state.meta, results:state.results}));
    state.idx++; presentNext();
  }

  function pauseToggle(){ if(!state.running) return; state.paused=!state.paused; if(state.paused){ setStatus('å·²æš‚åœ'); if(state.rec && state.rec.state==='recording') stopRec(); } else { setStatus('è¿›è¡Œä¸­'); presentNext(true); } }

  async function finish(){
    state.running=false; setUIRunning(false); setStatus('å®Œæˆ'); setStim('ğŸ‘ å·²å®Œæˆ'); setTimers('â€”','â€”'); updateProgress(); $('#btnExportCsv').disabled=state.results.length===0; $('#btnExportJson').disabled=state.results.length===0;
    await stopSessionRecording();
    if(state.sessionChunks.length){ const blob=new Blob(state.sessionChunks,{type: state.sessionChunks[0]?.type || 'audio/webm'}); const url=URL.createObjectURL(blob); const name=`${state.meta.studyId||'JWAT'}_${state.meta.pid||'PID'}_SESSION_${new Date().toISOString().replaceAll(':','-')}.webm`; const box=$('#sessionAudioBox'); box.style.display='block'; const p=document.createElement('p'); const audio=document.createElement('audio'); audio.controls=true; audio.src=url; const a=document.createElement('a'); a.href=url; a.download=name; a.textContent='ä¸‹è½½æ•´åœºéŸ³é¢‘'; p.textContent='æ•´åœºå½•éŸ³ï¼š'; p.appendChild(audio); p.appendChild(document.createTextNode(' ')); p.appendChild(a); box.innerHTML=''; box.appendChild(p);} }
  function stopEarly(){ if(!state.running){ alert('å°šæœªå¼€å§‹ã€‚'); return;} finish(); }
  function resetAll(){ if(!confirm('ç¡®å®šæ¸…ç©ºå½“å‰è¡¨æ ¼ä¸æœ¬åœ°ç¼“å­˜ï¼Ÿ')) return; state={running:false,paused:false,order:'original',isi:800,maxDur:8000,autoRec:'off',list:[],idx:0,tStim:0,tRecStart:0,meta:{},results:[],media:null,rec:null,recTimeout:null,chunks:[],recMode:$('#recMode').value,sessionRec:null,sessionChunks:[],sessionStart:0}; $('#tbl tbody').innerHTML=''; setStim('â€”'); setTimers('â€”','â€”'); setStatus('æœªå¼€å§‹'); $('#progBar').style.width='0%'; localStorage.removeItem('JWAT_VOICE_LAST'); $('#sessionAudioBox').style.display='none'; }

  async function saveTrial(blob,duration){
    const w=state.list[state.idx]; const firstLatency= state.tRecStart? Math.round(state.tRecStart-state.tStim):''; const note=($('#note').value||'').trim(); const ts=new Date().toISOString().replaceAll(':','-');
    let rows=[];
    // ä»…â€œæ¯é¢˜å½•éŸ³â€ä¸” segEnable=on æ—¶æ‰åšé™éŸ³åˆ†å‰²
    if(blob && (state.recMode==='trial_manual' || state.recMode==='trial_auto') && $('#segEnable').value==='on'){
      try{ const segs = await segmentBySilence(blob, {rmsThresh:+$('#segThresh').value, minSilenceMs:+$('#segMinSil').value, minChunkMs:+$('#segMinChunk').value}); if(segs.length>0){ rows = segs.map((b,idx)=>({blob:b, nameSuffix:'_'+(idx+1), durHint:null})); } }catch(e){ console.warn('é™éŸ³åˆ†å‰²å¤±è´¥ï¼Œé€€å›æ•´æ®µï¼š', e); rows=[]; }
    }
    if(rows.length===0){ rows=[{blob: blob, nameSuffix:'', durHint:duration}]; }

    for(let k=0;k<rows.length;k++){
      const r = rows[k];
      let url='', name='', mime='';
      if(r.blob){ name=`${state.meta.studyId||'JWAT'}_${state.meta.pid||'PID'}_${String(state.idx+1).padStart(3,'0')}_${w}${r.nameSuffix}_${ts}.webm`; url=URL.createObjectURL(r.blob); mime=r.blob.type||'audio/webm'; }
      let asrText='';
      if(r.blob && $('#asrEnable').value==='on' && $('#asrUrl').value.trim()){
        try{ asrText = await transcribeWithAPI(r.blob); }catch(e){ console.warn('ASR å¤±è´¥ï¼š', e); asrText='(ASR å¤±è´¥)'; }
      }
      const row={index:state.results.length+1, word:w, firstLatency, duration: r.durHint ?? '', asrText, audioUrl:url, audioName:name, note, mime};
      addRow(row); state.results.push({...row});
    }
    localStorage.setItem('JWAT_VOICE_LAST', JSON.stringify({meta:state.meta, results:state.results}));
  }

  function addRow(r){
    const tr=document.createElement('tr');
    const audioCell=document.createElement('td');
    if(r.audioUrl){ const player=document.createElement('audio'); player.controls=true; player.src=r.audioUrl; audioCell.appendChild(player); const dl=document.createElement('a'); dl.href=r.audioUrl; dl.download=r.audioName; dl.textContent='ä¸‹è½½'; dl.style.marginLeft='8px'; audioCell.appendChild(dl);} else { audioCell.textContent='(æ— )'; }
    const cells=[r.index, r.word, r.firstLatency, r.duration, r.asrText||'', null, r.note||''];
    cells.forEach((c,i)=>{ const td= i===5? audioCell : (function(){ const td=document.createElement('td'); td.textContent= c==null?'':c; return td; })(); tr.appendChild(td); });
    $('#tbl tbody').appendChild(tr);
  }

  async function transcribeWithAPI(blob){ const url = ($('#asrUrl').value||'').trim(); const key = ($('#asrKey').value||'').trim(); const extra = ($('#asrExtra').value||'').trim(); if(!url) return ''; const form = new FormData(); form.append('file', new File([blob], 'audio.webm', {type: blob.type||'audio/webm'})); if(extra){ try{ const obj=JSON.parse(extra); Object.entries(obj).forEach(([k,v])=>form.append(k, typeof v==='string'?v:JSON.stringify(v))); }catch(e){} } const resp = await fetch(url, { method:'POST', headers: key? { 'Authorization': 'Bearer '+key } : {}, body: form }); if(!resp.ok) throw new Error('ASR HTTP '+resp.status); const data = await resp.json().catch(()=>({})); return data.text || data.transcript || (data.result && data.result.hypothesis) || JSON.stringify(data).slice(0,200); }

  function buildCsv(meta, results){ const header=['index','word','firstLatency_ms','recording_ms','asrText','audioName','note','pid','age','sex','studyId','startedAt']; const rows=results.map(r=>[r.index,r.word,r.firstLatency,r.duration,r.asrText||'',r.audioName||'',r.note||'',meta.pid,meta.age,meta.sex,meta.studyId,meta.startedAt]); return [header.map(csvEscape).join(','), ...rows.map(row=>row.map(csvEscape).join(','))].join('\n'); }
  function exportCsv(){ const csv=buildCsv(state.meta, state.results); const fname=`${state.meta.studyId||'JWAT'}_${state.meta.pid||'PID'}_${new Date().toISOString().replaceAll(':','-')}.csv`; download(fname,csv,'text/csv;charset=utf-8'); }
  function exportJson(){ const payload={meta:state.meta, results: state.results.map(r=>({...r, audioUrl: undefined}))}; const fname=`${state.meta.studyId||'JWAT'}_${state.meta.pid||'PID'}_${new Date().toISOString().replaceAll(':','-')}.json`; download(fname, JSON.stringify(payload,null,2)); }

  // äº‹ä»¶
  $('#btnStart').addEventListener('click', start); $('#btnStop').addEventListener('click', stopEarly); $('#btnReset').addEventListener('click', resetAll); $('#btnRec').addEventListener('click', startRec); $('#btnStopRec').addEventListener('click', stopRec); $('#btnSkip').addEventListener('click', skipCurrent); $('#btnPause').addEventListener('click', pauseToggle); $('#btnExportCsv').addEventListener('click', exportCsv); $('#btnExportJson').addEventListener('click', exportJson); $('#btnRunTests').addEventListener('click', DEV_runTests); $('#recMode').addEventListener('change', ()=>{ state.recMode=$('#recMode').value; refreshModeUI(); });

  // å¿«æ·é”®
  window.addEventListener('keydown',(e)=>{ if(e.key==='s' || e.key==='S'){ start(); } else if(e.key==='r' || e.key==='R'){ if($('#btnRec').disabled) stopRec(); else startRec(); } else if(e.key===' '){ e.preventDefault(); if(state.running) { if(state.recMode==='none' || state.recMode==='session_single') stopRec(); else skipCurrent(); } } else if(e.key==='Escape'){ if(state.running) pauseToggle(); } });

  // æ¢å¤å†å²
  (function restore(){ const saved=localStorage.getItem('JWAT_VOICE_LAST'); if(!saved) return; try{ const d=JSON.parse(saved); if(d?.meta && d?.results){ setStatus('å·²æ¢å¤å†å²æ•°æ®ï¼ˆè¡¨æ ¼å¯å¯¼å‡ºï¼›éœ€é‡æ–°å¼€å§‹æµ‹è¯•ï¼‰'); d.results.forEach(r=> addRow(r)); state.results=[...d.results]; $('#btnExportCsv').disabled=state.results.length===0; $('#btnExportJson').disabled=state.results.length===0; } }catch(err){ console.warn('æ¢å¤å¤±è´¥',err);} })();

  // ====== éŸ³é¢‘é™éŸ³åˆ†å‰² & WAV ç¼–ç ï¼ˆä»…æ¯é¢˜å½•éŸ³æ¨¡å¼ä½¿ç”¨ï¼‰ ======
  async function segmentBySilence(blob, {rmsThresh=0.015, minSilenceMs=350, minChunkMs=200}={}){
    const ac = new (window.AudioContext||window.webkitAudioContext)();
    const buf = await blob.arrayBuffer();
    const audio = await ac.decodeAudioData(buf);
    const ch = audio.getChannelData(0);
    const sr = audio.sampleRate;
    const frame = 1024; const hop = frame; const rms = [];
    for(let i=0;i<ch.length;i+=hop){ let sum=0; for(let j=i;j<Math.min(i+frame,ch.length);j++){ const v=ch[j]; sum += v*v; } rms.push(Math.sqrt(sum/Math.min(frame,ch.length-i))); }
    const msPerFrame = 1000*hop/sr; const silFrames = Math.ceil(minSilenceMs/msPerFrame); const minFrames = Math.ceil(minChunkMs/msPerFrame);
    const cuts=[0]; let silentRun=0; for(let i=0;i<rms.length;i++){ if(rms[i] < rmsThresh) silentRun++; else silentRun=0; if(silentRun>=silFrames){ const end = Math.max(0, Math.round((i-silentRun/2)*hop)); if(end - cuts[cuts.length-1] >= minFrames*hop){ cuts.push(end); } silentRun=0; } }
    if(cuts[cuts.length-1] !== ch.length) cuts.push(ch.length);
    const out=[]; for(let k=0;k<cuts.length-1;k++){ const a=cuts[k], b=cuts[k+1]; if(b-a < minFrames*hop) continue; const slice = ch.slice(a,b); const wav = encodeWAV([slice], sr); out.push(wav); }
    try{ ac.close(); }catch(e){}
    return out;
  }
  function encodeWAV(channels, sampleRate){ const numCh = channels.length; const length = channels[0].length; const bytesPerSample = 2; const blockAlign = numCh*bytesPerSample; const byteRate = sampleRate*blockAlign; const dataSize = length*blockAlign; const buffer = new ArrayBuffer(44 + dataSize); const view = new DataView(buffer); function writeStr(off,str){ for(let i=0;i<str.length;i++) view.setUint8(off+i, str.charCodeAt(i)); } let off=0; writeStr(off,'RIFF'); off+=4; view.setUint32(off, 36+dataSize, true); off+=4; writeStr(off,'WAVE'); off+=4; writeStr(off,'fmt '); off+=4; view.setUint32(off,16,true); off+=4; view.setUint16(off,1,true); off+=2; view.setUint16(off,numCh,true); off+=2; view.setUint32(off,sampleRate,true); off+=4; view.setUint32(off,byteRate,true); off+=4; view.setUint16(off,blockAlign,true); off+=2; view.setUint16(off,16,true); off+=2; writeStr(off,'data'); off+=4; view.setUint32(off,dataSize,true); off+=4; for(let i=0;i<length;i++){ for(let ch=0; ch<numCh; ch++){ let s = Math.max(-1, Math.min(1, channels[ch][i] || 0)); view.setInt16(off, s<0 ? s*0x8000 : s*0x7FFF, true); off+=2; } } return new Blob([buffer], {type:'audio/wav'}); }

  // ===== å†…ç½®è‡ªæ£€ï¼ˆæµ‹è¯•ç”¨ä¾‹ï¼‰ =====
  function log(msg){ const el=$('#devLog'); el.textContent += (msg+'\n'); }
  function ok(name){ log('âœ… '+name); }
  function fail(name,err){ log('âŒ '+name+'\n   '+err); }
  function DEV_runTests(){
    $('#devLog').textContent='';
    try{
      // TC1: æ¢è¡Œåˆ‡åˆ†ï¼ˆ\n / \r\n / \rï¼‰
      const parts='a\nb\r\nc\rd'.split(/\r?\n|\r/); if(parts.length===4 && parts[0]==='a' && parts[3]==='d') ok('TC1 æ¢è¡Œåˆ‡åˆ†'); else throw new Error('åˆ‡åˆ†å¼‚å¸¸');
      // TC2: CSV è½¬ä¹‰ï¼ˆé€—å·ä¸æ¢è¡Œï¼‰
      if(csvEscape('x,y')==='"x,y"' && csvEscape('x\ny')==='"x\ny"') ok('TC2 CSV è½¬ä¹‰'); else throw new Error('CSVè½¬ä¹‰å¼‚å¸¸');
      // TC3: CSV ç»“æ„ï¼ˆ2 è¡Œï¼Œè¡¨å¤´+1 æ•°æ®ï¼‰
      const csv=buildCsv({pid:'P',age:'20',sex:'F',studyId:'S',startedAt:'T'},[{index:1,word:'å¤´',firstLatency:100,duration:500,asrText:'hi',audioName:'a.wav',note:''}]);
      const lines=csv.split('\n'); if(lines.length===2 && /^index,word/.test(lines[0]) && /^1,/.test(lines[1])) ok('TC3 CSV ç»“æ„'); else throw new Error('CSVç»“æ„å¼‚å¸¸');
      // TC4: é™éŸ³åˆ†å‰²é€»è¾‘ï¼ˆçº¯é™éŸ³åº”äº§ç”Ÿ0ç‰‡æ®µæˆ–ç©ºæ•°ç»„ï¼‰
      (async()=>{ const sr=16000; const silence=new Float32Array(sr*0.5); const wav=encodeWAV([silence],sr); const segs=await segmentBySilence(wav,{rmsThresh:0.01,minSilenceMs:100, minChunkMs:200}); if(Array.isArray(segs)) ok('TC4 é™éŸ³åˆ†å‰²APIå¯è°ƒç”¨'); })();
      // TC5: æ­£åˆ™å¯ç¼–è¯‘
      const re = /\r?\n|\r/; if(re instanceof RegExp) ok('TC5 æ­£åˆ™å¯ç¼–è¯‘'); else throw new Error('æ­£åˆ™å®ä¾‹åŒ–å¤±è´¥');
      // TC6: æ¨¡å¼åˆ‡æ¢æŒ‰é’®æ–‡æ¡ˆ
      const prev=$('#btnRec').textContent; state.recMode='none'; refreshModeUI(); if($('#btnRec').textContent.includes('å¼€å§‹ååº”')) ok('TC6 æ¨¡å¼æŒ‰é’®æ–‡æ¡ˆï¼ˆä¸å½•éŸ³ï¼‰'); else throw new Error('æŒ‰é’®æ–‡æ¡ˆæœªåˆ‡æ¢'); state.recMode='trial_manual'; refreshModeUI(); if($('#btnRec').textContent.includes('å¼€å§‹å½•éŸ³')) ok('TC6b æ¨¡å¼æŒ‰é’®æ–‡æ¡ˆï¼ˆæ¯é¢˜ï¼‰'); else throw new Error('æŒ‰é’®æ–‡æ¡ˆæœªåˆ‡å›'); $('#btnRec').textContent=prev;
      ok('åŒæ­¥æµ‹è¯•å·²å®Œæˆ');
    }catch(err){ fail('æµ‹è¯•å¤±è´¥', err.message||err); }
  }
  </script>
</body>
</html>
